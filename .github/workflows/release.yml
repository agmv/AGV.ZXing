
name: Release

on:
  workflow_dispatch:
  push:
    tags: [ '*' ]

jobs:  
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
            dotnet-version: 8.0.x
      - name: Restore dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --no-restore
      - name: Publish
        run: dotnet publish AGV.ZXing -c Release -r linux-x64 --no-self-contained -o publish
      - run: |
          ls -la publish
      - name: Upload ZIP artifact
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:            
            name: ZXingLib
            path: publish/
      - name: Display Artifact Info
        run: |
          echo "Artifact URL: ${{ steps.upload-artifact.outputs.artifact-url }}"
    outputs:
      artifact_url: ${{ steps.upload-artifact.outputs.artifact-url }}
  release:
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: write
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: ZXingLib
          path: ZXingLib
      - name: ZIP it
        run: |
          ls -la .
          tar -czf ZXingLib.zip -C ZXingLib .
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body: "Release of version ${{ github.ref_name }}"
          files: ZXingLib.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: |
          echo 'https://github.com/${{ github.repository}}/releases/download/${{ github.ref_name }}/ZXingLib.zip'
    outputs:
      release_artifact: 'https://github.com/${{ github.repository}}/releases/download/${{ github.ref_name }}/ZXingLib.zip'
  upload_to_odc:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Get Token Endpoint
        id: token-endpoint
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ vars.TENANT_URL }}/identity/.well-known/openid-configuration
          method: 'GET'
      - name: Get Access Token
        id: access-token
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ fromJson(steps.token-endpoint.outputs.response).token_endpoint }}
          method: 'POST'
          contentType: 'application/x-www-form-urlencoded'
          data: 'grant_type=client_credentials&client_id=${{ vars.ODC_CLIENT_ID }}&client_secret=${{ secrets.ODC_CLIENT_SECRET }}&scope=openid+profile+email'        
      - name: Upload Package to ODC
        id: upload-odc
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ vars.TENANT_URL }}/api/external-libraries/v1/generation-operations
          method: 'POST'
          bearerToken: ${{ fromJson(steps.access-token.outputs.response).access_token }}
          contentType: 'application/json'
          data: '{ "fileName": "ZXingLib.zip", "highCodeBinaryUri": "${{ needs.release.outputs.release_artifact }}" }'